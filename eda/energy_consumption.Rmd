---
title: Energy Consumption Sources by State
author: Avery Rogers
date: "`r Sys.Date()`"
output: 
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
# Libraries
library(tidyverse)
library(ggalluvial)
library(lubridate)

# Parameters

  # Energy consumption data from EIA
energy_data <- "~/Downloads/use_all_btu.csv"

  # State population data from FRED
population_data <- "~/Downloads/state_population.csv"

# MSN codes to keep
msn_to_keep <- 
  c(
    "CLTCB", 
    "GETCB", 
    "HYTCB", 
    "NGTCB", 
    "NUETB", 
    "SOTCB", 
    "WWTCB",
    "WYTCB"
  )

# Recode MSN values
recode_msn <- 
  c(
    "CLTCB" = "Coal",
    "GETCB" = "Geothermal",
    "HYTCB" =  "Hydropower",
    "NGTCB" = "Natural Gas", 
    "NUETB" = "Nuclear", 
    "SOTCB" = "Solar",
    "WWTCB" = "Wood and Waste", 
    "WYTCB" = "Wind"
  ) 

#===============================================================================


```

# Part I: Energy Consumption for Electricity by State and Year

In this section, I am only looking at the sources of energy that primarily contribute to electricity generation across states: coal, geothermal power, hydropower, natural gas, nuclear power, solar power, wood and waste power, and wind power. I remove all the other energy usage statistics from the dataset to hone in on these. Most notably, I remove petroleum, which is the largest source of energy in many states but primarily for transportation rather than electriticy in the grid. Petroleum usage will be covered in a later section. 

An important note about this data: all energy usage is measured in BTU, or British Thermal Units. One BTU is the amount of energy needed to raise one pound of water by one degree Fahrenheit. (I'm not sure why it's called _British_ thermal units if the measurements it uses are imperial!). One BTU is approximately 1,055 joules. BTU is the unit used to sell natural gas in the US (dollars per million BTUs), and is the best unit of measurement for comparing different energy sources. 

## Cleaning Data


```{r}
energy_data_clean <- 
  read_csv(energy_data) %>% 
  rename_all(str_to_lower) %>% 
  select(-data_status) %>% 
  pivot_longer(c("1960":"2017"), names_to = "year", values_to = "amount") %>% 
  mutate(year = as.integer(year)) %>% 
  select(state, year, msn, amount) %>% 
  filter(msn %in% msn_to_keep) %>% 
  mutate_at(vars(msn), recode, !!! recode_msn) %>% 
  mutate(amount = replace_na(amount, 0))

energy_data_clean
```

## Getting percentages by source for each year and state

```{r}
consumption_fractions <- 
  energy_data_clean %>% 
  group_by(state, year) %>% 
  mutate(total_cons = sum(amount)) %>% 
  ungroup() %>% 
  mutate(frac_amount = amount / total_cons) %>% 
  select(state, year, msn, frac_amount)

consumption_fractions
```


## Creating necessary plotting functions

```{r}
plot_fractions <- function(state_abbv, state) {
  consumption_fractions %>% 
    filter(state == state_abbv) %>% 
    ggplot(aes(x = year, y = frac_amount, alluvium = msn)) + 
    geom_alluvium(
      aes(fill = msn, color = msn), 
      width = 1/16, 
      alpha = 1/2, 
      decreasing = NA
    ) + 
    scale_x_continuous(
      breaks = seq(1960, 2015, 5),
      expand = c(0, 0)
    ) +
    scale_y_continuous(
      expand = c(0, 0),
      breaks = seq(0, 1, 0.1),
      minor_breaks = NULL,
      labels = scales::percent_format(accuracy = 1)
    ) +
    labs(
      x = "Year",
      y = "Percentage of Energy Consumption",
      title = str_glue("Energy Consumption by Source in {state}, Percentage"),
      caption = "Source: US Energy Information Administration",
      color = "Energy\nSource",
      fill = "Energy\nSource"
    ) +
    theme(
      panel.background = element_rect(fill = "grey95"),
      panel.grid.major = element_line(color = "white"),
      panel.grid.minor = element_line(color = "white")
    )
} 

plot_amount <- function(state_abbv, state) {
  energy_data_clean %>% 
    filter(state == state_abbv) %>% 
    ggplot(aes(x = year, y = amount, alluvium = msn)) + 
    geom_alluvium(
      aes(fill = msn, color = msn), 
      width = 1/16, 
      alpha = 1/2, 
      decreasing = NA
    ) + 
    scale_x_continuous(
      breaks = seq(1960, 2015, 5),
      expand = c(0, 0)
    ) +
    scale_y_continuous(
      expand = c(0, 0),
      labels = scales::number_format(accuracy = 1)
    ) +
    labs(
      x = "Year",
      y = "Amount (billion BTU)" ,
      title = str_glue("Energy Consumption by Source in {state}, Total Amount"),
      caption = "Source: US Energy Information Administration",
      color = "Energy\nSource",
      fill = "Energy\nSource"
    ) +
    theme(
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(color = "gray92"),
      panel.grid.minor = element_line(color = "gray92")
    )
}
```

## Example plot: Alaska

The Alaska plots demonstrate why it is interesting and important to plot not only the percentages of electricity-generating energy sources by year, but also the total amount of electricity-generating enegy sources by year. As we can see in the first plot, Alaska repidly transitions from minimal to very high usage of natural gas in the 1960s and 70s as a percentage of its energy sources. Looking at the second plot, we see a more nuanced story: it was not that Alaska used large amount of coal in the 1960s, but rather that their energy usage overall more than doubled from 1960 to 1970, and continued to grow rapidly in the decades afterwards. 

```{r}
plot_fractions("AK", "Alaska")
plot_amount("AK", "Alaska")
```

## Greatest Consumers By Fraction

```{r}
greatest_consumer <- function(target_msn, target_year) {
  consumption_fractions %>% 
    filter(msn == target_msn, year == target_year) %>% 
    mutate(state = fct_reorder(state, frac_amount)) %>%
    ggplot(aes(state, frac_amount)) + 
    geom_point() +
    coord_flip() +
    scale_y_continuous(
      labels = scales::percent_format(accuracy = 1)
    ) +
    labs(
      x = "State",
      y = str_glue("Percentage of Energy Consumption from {target_msn}"), 
      title = str_glue(
        "Comparative Energy Consumption from {target_msn} in {target_year}",
      caption = "Source: US Energy Information Administration"
      )
    ) +
    theme(
      panel.background = element_rect(fill = "grey98"),
      panel.grid.major = element_line(color = "grey92"),
      panel.grid.minor = element_line(color = "grey92")
    )
} 
```

## Example: Wood and Waste 2017

The northeastern states of Maine, New Hampshire, and Vermont consume a large fraction of energy sourced from wood and waste as of 2017. Who knew!

```{r, fig.height = 7}
greatest_consumer("Wood and Waste", 2017)
```


# Part II: Energy Usage by Population

In this section, I wanted to understand the relationship between energy usage and state population and see whether increases in energy usage were accelerating faster or slower than overall population growth by state. This will help shed more light on how energy consumption is changing per capita and whether or not we are headed in the right direction in terms of sustainability. 

## Cleaning Population Data

```{r}
population_data_clean <- 
  read_csv(population_data) %>% 
  pivot_longer(
    cols = c(AKPOP:WYPOP), 
    names_to = "state", 
    values_to = "population"
  ) %>% 
  mutate_at(vars(state), ~ str_sub(., 1, 2)) %>% 
  mutate(
    year = as.integer(year(DATE)),
    population_thousands = as.integer(population)
  ) %>% 
  select(year, state, population_thousands) %>% 
  filter(year > 1959, year < 2018)

population_data_clean
```

## Combining The Tibbles

Here, I add a variable `amount_per_capita` to see how much energy is being used per each 1,000 people in the state. 

```{r}
total_energy_population <- 
  energy_data_clean %>% 
  left_join(population_data_clean, by = c("year", "state")) %>% 
  mutate(amount_per_capita = amount / population_thousands)

fraction_energy_population <- 
  consumption_fractions %>% 
  left_join(population_data_clean, by = c("year", "state"))
```


## Total Energy Consumption Per Capita by State over Time

When comparatively plotting the total energy consumption per 1,000 people by state over time, we see very surprising results: some states are using as much as 3x the amount of energy per capita as others. 

```{r}
per_capita_energy <- function(state_abbv) { 
  total_energy_population %>% 
    filter(state %in% state_abbv) %>% 
    count(state, year, wt = amount_per_capita) %>% 
    ggplot(aes(year, n, color = state)) +
    geom_line() +
    scale_x_continuous(
      breaks = seq(1960, 2020, 5), 
      expand = c(0, 0)
    ) +
    labs(
      x = "Year", 
      y = "Total Energy Consumption in BTUs per 1,000 People",
      title = "Comparing total energy use per capita in US states",
      color = "State",
      caption = "Sources: St. Louis Fred, US Energy Information Administration"
    ) +
    theme(
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(color = "grey92"),
      panel.grid.minor = element_line(color = "grey92")
    )
}
```

## Example States

As we can see, variation among states' per-capita energy consumption is high, with a state like Kentucky consuming nearly three times as many BTUs of energy per 1,000 people as California. 

```{r}
per_capita_energy(c("FL", "CA", "CT", "CO", "PA", "KY"))
```


## State energy consumption per capita by source 

Here, I look at at comparing the use of different energy sources per 1,000 people within a state. It's particularly interesting to see how sources have substituted over time, and whether or not the overall trend is increasing or decreasing. This supplements the total usage by source graphs above by paying closer attention to the usage standardized for population changes. 

```{r}
per_capita_compare <- function(state_abbv, state, msn_vars) {
  total_energy_population %>% 
  filter(state == state_abbv, msn %in% msn_vars) %>% 
  ggplot(aes(year, amount_per_capita, color = msn)) +
  geom_line() +
  scale_x_continuous(
    breaks = seq(1960, 2020, 5), 
    expand = c(0, 0)
  ) +
  scale_y_continuous(expand = c(0, 0)) + 
  labs(
    x = "Year", 
    y = "Total Energy Consumption per 1,000 People (BTUs)",
    title = str_glue("{state} energy use per capita by energy source"),
    color = "Energy\nSource",
    caption = "Sources: St. Louis FRED, US Energy Information Administration"
  ) +
  theme(
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_line(color = "grey92"),
    panel.grid.minor = element_line(color = "grey92")
  )
}
```

## Example: Maine

We see a sudden spike in natural gas consumption per capita in Maine that trails off after its peak. Hydropower and wood and waste power stay relatively constant after 1980. 

```{r}
per_capita_compare(
  "ME", 
  "Maine", 
  c("Coal", "Natural Gas", "Wood and Waste", "Hydropower")
)
```

